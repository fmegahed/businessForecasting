---
title: "ISA 444: Business Forecasting"
subtitle: "14 - Autocorrelation and Seasonality"
author: Fadel M. Megahed
date: 'Fall 2020'
output:
  beamer_presentation:
    number_sections: false
    toc: false
    slide_level: 3
    includes: 
      in_header: structure.txt
classoption: "aspectratio=169"
always_allow_html: yes
bibliography: refs.bib
link-citations: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      verbose = FALSE,
                      progress = FALSE,
                      fig.align = "center",
                      fig.pos = 'p',
                      fig.width = 5.8,
                      fig.height= 2.9,
                      allowframebreaks = TRUE,
                      fig.margin=TRUE,
                      kable.force.latex = TRUE,
                      cache = TRUE)
options(kableExtra.latex.load_packages = FALSE)
pacman::p_load(kableExtra, tidyverse, tidyquant, xtable, magrittr, fpp2, ggpubr)
```

# Preface


### Quick Refresher on What we Covered in Chapter 06 so Far

\begin{block}{\textbf{Main Learning Outcomes Discussed in Chapter 06}}
		$\quad$ \textcolor{darkgreen}{\large \checkboxFadel} \textbf{Define the population mean, and variance of a random variable.} \\
		$\quad$ \textcolor{darkgreen}{\large \checkboxFadel} \textbf{Define the population covariance, and correlation between two random variables.} \\
		$\quad$ \textcolor{darkgreen}{\large \checkboxFadel} \textbf{Define the population autocovariance and autocorrelation of a random variable.} \\
		$\quad$ \textcolor{darkgreen}{\large \checkboxFadel} \textbf{Use sample estimates of the population mean, variance, covariance, and correlation.} \\
		$\quad$ \textcolor{darkgreen}{\large \checkboxFadel} \textbf{Explain the properties of the large sample distribution of the sample ACF.} \\
	$\quad$ \textcolor{darkgreen}{\large \checkboxFadel} \textbf{Use the large sample distribution of the sample ACF to identify significant autocorrelation in a time series.} \\
		$\quad$ \textcolor{miamired}{\large $\boxtimes$} \textbf{Determine if a sample ACF plot “cuts off” or “dies down”.}
\end{block}


### Some Time Series and their ACF Plots [1]

```{r simMA1, echo=FALSE}
#Generate MA processes of order 2
ma.sim1 = arima.sim(model=list(ma=c(.4,.9)),n=100)
p1 = ma.sim1 %>% autoplot() + theme_bw() + labs(y = 'Y')
p2 = acf(ma.sim1, plot = FALSE, lag.max = 12) %>% 
  autoplot() + theme_bw() + labs(title = NULL)

ggarrange(p1, p2,
          labels = c('MA(2)', ''),
           ncol = 1, nrow = 2)
```


### Some Time Series and their ACF Plots [2]
```{r simMA2, echo=FALSE}
ma.sim2 = arima.sim(model=list(ma=c(.4,.6,.7)),n=100)
p1 = ma.sim2 %>% autoplot() + theme_bw() + labs(y = 'Y')
p2 = acf(ma.sim2, plot = FALSE, lag.max = 12) %>% 
  autoplot() + theme_bw() + labs(title = NULL)

ggarrange(p1, p2,
          labels = c('MA(3)', ''),
           ncol = 1, nrow = 2)
```


### Some Time Series and their ACF Plots [3]

```{r simAR1, echo=FALSE}
ar.sim1 = arima.sim(model=list(ar=c(.9)),n=500)
p1 = ar.sim1 %>% autoplot() + theme_bw() + labs(y = 'Y')
p2 = acf(ar.sim1, plot = FALSE, lag.max = 12) %>% 
  autoplot() + theme_bw() + labs(title = NULL)

ggarrange(p1, p2,
          labels = c('AR(1): 0.9', ''),
           ncol = 1, nrow = 2)
```


### Some Time Series and their ACF Plots [4]

```{r simAR1-2, echo=FALSE}
ar.sim2 = arima.sim(model=list(ar=c(-.9)),n=500)
p1 = ar.sim2 %>% autoplot() + theme_bw() + labs(y = 'Y')
p2 = acf(ar.sim2, plot = FALSE, lag.max = 12) %>% 
  autoplot() + theme_bw() + labs(title = NULL)

ggarrange(p1, p2,
          labels = c('AR(1): -0.9', ''),
           ncol = 1, nrow = 2)
```


### Some Time Series and their ACF Plots [5]

```{r google, echo=FALSE}
GOOG = getSymbols('GOOG', from = '2019-01-01', to = '2020-09-30', auto.assign = FALSE)
GOOG = GOOG$GOOG.Adjusted
p1 = GOOG %>% autoplot() + theme_bw()
p2 = acf(GOOG, plot = FALSE, lag.max = 12) %>% 
  autoplot() + theme_bw() + labs(title = NULL)

ggarrange(p1, p2, ncol = 1, nrow = 2)
```


### Learning Objectives for Today's Class
\begin{block}{\textbf{Main Learning Outcomes}}
  \begin{itemize}
      \item \textbf{Determine if a sample ACF plot “cuts off” or “dies down”.}
			\item \textbf{Explain how sample partial autocorrelation is calculated.}
			\item \textbf{Define the term “weakly stationary” and recognize time series that do not fit this definition.}
			\item \textbf{Use the sample ACF plot to identify a nonstationary time series.}
	\end{itemize}
\end{block}




# Partial Autocorrelation


### Definition: General

**Statistical Definition:** Let us say that we have three variables, $X$, $Y$, and $Z$, all correlated, and we want to know how $X$ and $Y$ are correlated after we remove the effects of $Z$ on each.


**Computation Approach:**

\begin{center}
$\hat{X} = a_1 + b_1Z; \qquad \qquad X^* = X - \hat{X}$ 

$\hat{Y} = a_2 + b_2Z; \qquad \qquad Y^* = Y - \hat{Y}$ 
\end{center}


$Corr(X^*, Y^*)$ is the Partial Autocorrelation between $X$ and $Y$. It is the correlation that remains after we remove the effect of $Z$.


### PACF in the Context of Time-Series Analysis
The Partial Autocorrelation between $Y_t$ and $Y_{t+k}$ is the correlation between $Y_t$ and $Y_{t+k}$ after removing the effects of $Y_{t+1}, \, Y_{t+2}, \, Y_{t+3}, \, \dots, \, Y_{t+k-1}$.  

  - We plot the partial autocorrelation over multiple lags just like the autocorrelation function (ACF).  
  - We refer to the plotted partial autocorrelations as the PACF.


### Some Time Series and their PACF Plots [1]
```{r maSim1PACF, echo=FALSE}
p1 = ma.sim1 %>% autoplot() + theme_bw() + labs(y = 'Y')
p2 = acf(ma.sim1, plot = FALSE, lag.max = 12) %>% 
  autoplot() + theme_bw() + labs(title = NULL)
p3 = pacf(ma.sim1, plot = FALSE, lag.max = 12) %>% 
  autoplot() + theme_bw() + labs(title = NULL)

ggarrange(p1, p2, p3,
          labels = c('MA(2)', '', ''),
           ncol = 1, nrow = 3)
```


### Some Time Series and their PACF Plots [2]
```{r maSim2PACF, echo=FALSE}
p1 = ma.sim2 %>% autoplot() + theme_bw() + labs(y = 'Y')
p2 = acf(ma.sim2, plot = FALSE, lag.max = 12) %>% 
  autoplot() + theme_bw() + labs(title = NULL)
p3 = pacf(ma.sim2, plot = FALSE, lag.max = 12) %>% 
  autoplot() + theme_bw() + labs(title = NULL)

ggarrange(p1, p2, p3,
          labels = c('MA(3)', '', ''),
           ncol = 1, nrow = 3)
```

### Some Time Series and their PACF Plots [3]
```{r arSim1PACF, echo=FALSE}
p1 = ar.sim1 %>% autoplot() + theme_bw() + labs(y = 'Y')
p2 = acf(ar.sim1, plot = FALSE, lag.max = 12) %>% 
  autoplot() + theme_bw() + labs(title = NULL)
p3 = pacf(ar.sim1, plot = FALSE, lag.max = 12) %>% 
  autoplot() + theme_bw() + labs(title = NULL)

ggarrange(p1, p2, p3,
          labels = c('AR(1): 0.9', '', ''),
           ncol = 1, nrow = 3)
```


### Some Time Series and their PACF Plots [4]
```{r arSim2PACF, echo=FALSE}
p1 = ar.sim2 %>% autoplot() + theme_bw() + labs(y = 'Y')
p2 = acf(ar.sim2, plot = FALSE, lag.max = 12) %>% 
  autoplot() + theme_bw() + labs(title = NULL)
p3 = pacf(ar.sim2, plot = FALSE, lag.max = 12) %>% 
  autoplot() + theme_bw() + labs(title = NULL)

ggarrange(p1, p2, p3,
          labels = c('AR(1): -0.9', '', ''),
           ncol = 1, nrow = 3)
```


### Some Time Series and their PACF Plots [5]

```{r googlePACF, echo=FALSE}
p1 = GOOG %>% autoplot() + theme_bw()
p2 = acf(GOOG, plot = FALSE, lag.max = 12) %>% 
  autoplot() + theme_bw() + labs(title = NULL)
p3 = pacf(GOOG, plot = FALSE, lag.max = 12) %>% 
  autoplot() + theme_bw() + labs(title = NULL)

ggarrange(p1, p2, p3, ncol = 1, nrow = 3) 
```


### What we have learned from the GOOG Example [1]

```{r GOOGscatter, echo=FALSE}
google = data.frame(adjusted = as.vector(GOOG) %>% round(0), 
                    lag1price = as.vector(GOOG) %>% lag() %>% round(0))
google %>% ggplot(aes(x = lag1price, y = adjusted)) +
  geom_point() + theme_bw() 
```

### What we have learned from the GOOG Example [2]
```{r googleLM, echo=FALSE, results='asis'}
model = lm(data = google, adjusted ~ lag1price) 
stargazer::stargazer(model, font.size = 'scriptsize', header = FALSE)
```


### What we have learned from the GOOG Example [3]
```{r googleDiff1, echo=FALSE}
googleDiff = c(NA, diff(google$adjusted))  
googleDiff = xts(x = googleDiff, order.by = date(GOOG)) %>% na.omit()
googleDiff %>% autoplot() + theme_bw() 
```

### What we have learned from the GOOG Example [4]
```{r googleDiff2, echo=FALSE}
p2 = acf(googleDiff, plot = FALSE, lag.max = 12) %>% 
  autoplot() + theme_bw() + labs(title = NULL)
p3 = pacf(googleDiff, plot = FALSE, lag.max = 12) %>% 
  autoplot() + theme_bw() + labs(title = NULL)

ggarrange(p2, p3, ncol = 1, nrow = 2)
```

# Stationarity


### Stationarity: A Formal Definition

**Weak Stationarity:** A weakly stationary time series is a finite variance process such that:  

  1. The mean, $\mu_t$, is constant and does not depend on the time $t$; and   
  2. The autocovariance function, $\gamma(s, t)$ depends on $s$ and $t$ only through their difference $|s-t|$.  
  
We will use the term “stationary” to refer to weak stationarity.  

  - The concept of weak stationarity forms the basis of much of the foundation for time series modeling.  
  - The fundamental properties (1 & 2) required for weak stationarity are satisfied by many of the models that are widely used.


### Stationarity: A Visual Explanation

```{r Stationary, echo=FALSE}
ar.sim = arima.sim(model=list(ar=c(.6)),n=500)

p1 = ar.sim %>% autoplot() + theme_bw() + labs(y = 'AR(1): 0.6')
p2 = acf(ar.sim, plot = FALSE, lag.max = 12) %>% 
  autoplot() + theme_bw() + labs(title = NULL)

ggarrange(p1, p2, ncol = 1, 
          labels = c('', ''), nrow = 2) 
```



### Non-Stationarity: A Visual Explanation

```{r nonStationary, echo=FALSE}
ar.sim = arima.sim(list(order = c(1,1,0), ar = 0.6), n = 500)

p1 = ar.sim %>% autoplot() + theme_bw() + labs(y = 'ARIMA(1,1,0): 0.6')
p2 = acf(ar.sim, plot = FALSE, lag.max = 12) %>% 
  autoplot() + theme_bw() + labs(title = NULL)

ggarrange(p1, p2, ncol = 1, 
          labels = c('', ''), nrow = 2)  
```


### Stationarity: Some Thoughts??

**Based on the five examples depicted in Slides $4-8$ (or alternatively $13-17$), please identify which of the five series are stationary and which are not!!**

# Recap

### Summary of Main Points

\begin{block}{\textbf{Main Learning Outcomes}}
  \begin{itemize}
      \item \textbf{Determine if a sample ACF plot “cuts off” or “dies down”.}
			\item \textbf{Explain how sample partial autocorrelation is calculated.}
			\item \textbf{Define the term “weakly stationary” and recognize time series that do not fit this definition.}
			\item \textbf{Use the sample ACF plot to identify a nonstationary time series.}
	\end{itemize}
\end{block}



### Things to Do for Next Class

 - Thoroughly read Chapter 6.1 of our textbook.
 
 - Go through the slides, examples and make sure you have a good understanding of what we have covered. 



---

\maketitle